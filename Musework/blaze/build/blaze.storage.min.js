!function(){Blaze.Storage={},Blaze.Storage.Adaptor=function(a){this.suppressErrors=!1,this.actions={},this.initialize(a||{}),this.id||(this.id=_.uniqueId("storageAdptor_")),this.isAvailable()&&Blaze.dispatcher.trigger("storage:ready",this.id,this)},_.extend(Blaze.Storage.Adaptor.prototype,{initialize:function(){},isAsync:function(){return!1},gettable:null,settable:null,isAvailable:function(){return!1},get:function(){return!1},set:function(){return!1},action:function(a,b){if(!this.isAvailable())return!1;var c=this.actions[a];return c?c.call(this,b):(this.logError("has no action"+a),!1)},addAction:function(a,b){_.isFunction(b)||console.error(this.id,"storage action "+a+" must be a function"),this.actions[a]=b},getActionList:function(){return _.keys(this.actions)},onError:function(){this.logError("unknown error")},logError:function(a){this.suppressErrors||Blaze.dispatcher.trigger("storage:error",this.id,a)}}),Blaze.Storage.Adaptor.extend=Blaze._extend,Blaze.Storage.AiccAdaptor=Blaze.Storage.Adaptor.extend({attemptLimit:7,cmiMapping:{},initialize:function(a){this.id=a.id||"aicc"}}),Blaze.Storage.Scorm2004_2Adaptor=Blaze.Storage.Adaptor.extend({attemptLimit:7,cmiMapping:{},initialize:function(a){this.id=a.id||"aicc_hap"}}),Blaze.Storage.LocalStorageAdapter=Blaze.Storage.Adaptor.extend({initialize:function(a){this.id=a.id||"Local Storage",this.setActions(),this._isAvailable=window.store},isAvailable:function(){return this._isAvailable},set:function(a,b){return this.isAvailable()?store.set(a,b):!1},get:function(a){return this.isAvailable()?store.get(a):!1},setActions:function(){this.addAction("remove",function(a){return this.isAvailable()?void store.remove(a):!1}),this.addAction("clear",function(){return this.isAvailable()?void store.clear():!1})}}),Blaze.Storage.Scorm12Adaptor=Blaze.Storage.Adaptor.extend({attemptLimit:7,cmiMapping:{bookmark:"cmi.suspend_data",student_id:"cmi.core.student_id",student_name:"cmi.core.student_name",status:"cmi.core.lesson_status",mode:"cmi.core.lesson_mode",score:"cmi.core.score.raw",score_min:"cmi.core.score.max",score_max:"cmi.core.score.max",time:"cmi.core.total_time",interaction_count:"cmi.interactions._count"},initialize:function(a){this.id=a.id||"scorm_1_2";var b=this._getAPI(),c=_.keys(this.cmiMapping);if(this.gettable=c,this.settable=_.without(c,"student_name","student_id","interaction_count"),this.setActions(),b){if(this.api=b,"true"!=this.api.LMSInitialize("").toString())return this.onError(),!1;"not attempted"==this.get("status")&&this.set("status","incomplete"),this._restoreInteractionMap()}},setActions:function(){this.addAction("commit",function(){var a=this.api.LMSCommit("");return this.onError(),a}),this.addAction("finish",function(){var a=this.api.LMSFinish("");return this.onError(),a}),this.addAction("pass",function(){return this.set("status","passed")}),this.addAction("fail",function(){return this.set("status","failed")}),this.addAction("complete",function(){return"browse"==this.get("mode")?!1:this.checkComplete()?!0:this.set("status","completed")}),this.addAction("isComplete",function(){return this.checkComplete()}),this.addAction("start",function(){return this.checkComplete()?!0:this.set("status","incomplete")}),this.addAction("interaction",function(a){if(!a.id)return!1;var b=[],c=this._getInteractionN(a.id);return this._setInteractionData(c,"id",a.id),a.time&&(b.push(this._setInteractionData(c,"time",a.time)),this.onError("cmi.interaction."+c+".time")),a.type&&_.contains(["true-false","choice","fill-in","matching","performance","sequencing","likert","numeric"],a.type)&&(b.push(this._setInteractionData(c,"type",a.type)),this.onError("cmi.interaction."+c+".type")),a.pattern&&(b.push(this._setInteractionData(c,"correct_responses.0.pattern",a.pattern)),this.onError("cmi.interaction."+c+".correct_responses.0.pattern")),a.weighting&&(b.push(this._setInteractionData(c,"weighting",a.weighting)),this.onError("cmi.interaction."+c+".weighting")),a.response&&(b.push(this._setInteractionData(c,"student_response",a.response)),this.onError("cmi.interaction."+c+".student_response")),a.result&&(b.push(this._setInteractionData(c,"result",a.result)),this.onError("cmi.interaction."+c+".result")),!_.contains(b,"false")&&!_.contains(b,!1)})},checkComplete:function(){return _.contains(["completed","passed","failed"],this.get("status"))},onError:function(a){var b=this.api.LMSGetLastError().toString();"0"!=b&&(a||(a=""),b=a+" ("+b+")"+this.api.LMSGetErrorString(b)+" - "+this.api.LMSGetDiagnostic(b),this.logError(b))},_getInteractionN:function(a){console.log("interaction map",a),console.log("_getInteractionN",a);var b=this.get("interaction_count"),c=_.findWhere(this.interaction_map,{id:a});return console.log("_getInteractionN mapped",c),c?b=c.n:this.interaction_map.push({id:a,n:b}),b},_setInteractionData:function(a,b,c){console.log("_setInteractionData",a,b,c);var d=this.api.LMSSetValue("cmi.interactions."+a+"."+b,c);return this.onError(),d},_restoreInteractionMap:function(){var a,b=[],c=parseInt(this.get("interaction_count"));console.log("_restoreInteractionMap get interaction count",c),_.isNumber(c)&&_.each(_.range(c),function(c){a=this.get("cmi.interactions."+c+".id"),b.push({id:a,n:c})},this),this.interaction_map=b},isAvailable:function(){var a=this.api;return a||this.logError("could not find an SCORM API"),a},get:function(a){if(this.isAvailable()){var b,c=this.cmiMapping[a];return c?(b=this.api.LMSGetValue(c),this.onError(),b):void this.logError(a+" is not a valid scorm 1.2 variable")}},set:function(a,b){if(this.isAvailable()){var c,d=this.cmiMapping[a];return d?(c=this.api.LMSSetValue(d,b),this.onError(),c):void this.logError(a+" is not a valid scorm 1.2 variable")}},_findAPI:function(a){for(var b=0;!a.API&&!_.isNull(a.parent)&&a.parent!=a;){if(b++,b>this.attemptLimit)return this.logError("SCORM API too deeply nested."),null;a=a.parent}return a.API},_getAPI:function(){var a=this._findAPI(window);if(!a&&!_.isNull(window.opener)&&!_.isUndefined(window.opener))try{a=this._findAPI(window.opener)}catch(b){}return a?a:(this.logError("could not find an SCORM API"),null)}}),Blaze.Storage.Scorm2004_2Adaptor=Blaze.Storage.Adaptor.extend({attemptLimit:7,cmiMapping:{},initialize:function(a){this.id=a.id||"scorm_20004_2"}})}();