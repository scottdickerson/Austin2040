!function(){Blaze.Mixer.add("activity",{args:{completed:"bActivityCompleted",started:"bActivityStarted"},markStarted:function(){this.model.set(this.args.started,!0),this.hasMixin("globalEvents")&&this.triggerGlobal("activity:started",this.model,this)},isStarted:function(){return this.model.get(this.args.started)},markCompleted:function(){this.model.set(this.args.completed,!0),this.hasMixin("globalEvents")&&this.triggerGlobal("activity:completed",this.model,this)},isCompleted:function(){return this.model.get(this.args.completed)},next:function(){this.triggerGlobal("command:run","next")}}),Blaze.Mixer.add("attempts",{defaultConfig:{nTries:0},args:{tries:"nTries",record:"nAttemptRecord"},profileReady:function(){this.model.set(this.args.tries,0)},canAttempt:function(){return this.getAttempt()<=this.config.nTries},setAttempted:function(a){this.model.incCounter(this.args.tries),a&&this.recordAttempt(a)},getAttempt:function(){return this.model.get(this.args.tries)},resetAttempts:function(){this.model.set(this.args.tries,0),this.model.set(this.args.record,[])},recordAttempt:function(a){this.model.setPush(this.args.record,a)},getAttemptRecord:function(a){var b=this.model.get(this.args.record);if(b)return a?b[a]:b},mixinBeforeRemove:function(){this.resetAttempts()}}),Blaze.Mixer.add("gradable",{args:{answer:"answered",outcome:"grade",feedbackCorrect:"sCorrectFeedback",feedbackIncorrect:"sIncorrectFeedback"},defaultConfig:{bRepeatable:!0},profileReady:function(){this.config.sFeedbackAdaptor||(this.config.sFeedbackAdaptor="SimpleGenericFeedback")},setEvaluator:function(a){this.evaluator=a},grade:function(){var a=_.isFunction(this.evaluator)?this.evaluator(this.model):!0,b=a?"correct":"incorrect";return this.model.set(this.args.outcome,b),a?this.onCorrect():this.onIncorrect(),a},isCorrect:function(){return"correct"==this.getArg("grade")},setAnswered:function(a){this.model.set(this.args.answer,a)},getAnswered:function(){return this.model.get(this.args.answer)},onIncorrect:function(){},onCorrect:function(){},renderFeedback:function(){var a=Blaze.Adaptors.convert(this.config.sFeedbackAdaptor,this.model,this)||{};this.config.sFeedbackTemplate?this.subTemplate(".js-feedback",this.config.sFeedbackTemplate,a):this.$(".js-feedback").html(_.isString(a)?a:a.feedback),this.hasMixin("transitionable")?this.transitionOr("feedbackIn",function(){this.$(".js-feedback").show()}):this.$(".js-feedback").show()},close:function(){this.transitionOr("feedbackOut",function(){this.$(".js-feedback").hide()})}}),Blaze.Adaptors.add("SimpleGenericFeedback",function(){return{feedback:this.getArg(this.isCorrect()?"feedbackCorrect":"feedbackIncorrect")}}),Blaze.Mixer.add("timed",{onTimeReset:function(){},onTimeUp:function(){},onTimerTick:function(){},mixinBeforeInitialize:function(){_.bindAll(this,"_tickCountdown"),this._timerActive=!1},mixinAfterInitialize:function(){},defaultConfig:{bCountdown:!1,nTimer:30},startCountdown:function(){this.config.bCountdown&&(this.resetCountdown(),this._timerActive||(this._timerActive=!0,this._tickNext()))},stopCountdown:function(){this._timerActive=!1},resetCountdown:function(){this.model.set("timer",this.config.nTimer),this.onTimeReset()},_tickCountdown:function(){var a=this.model.decCounter("timer");0===a?(this.stopCountdown(),this.trigger("timer:out",a),this.onTimeUp(a)):(this.onTimerTick(a),this.trigger("timer:tick",a),this._tickNext())},_tickNext:function(){this._timeout=setTimeout(this._tickCountdown,1e3)},mixinBeforeRemove:function(){this._timeout&&clearTimeout(this._timeout),this._timeout=null}}),Blaze.dna.DragDrop=Blaze.View.extend({className:"activity-mult-select",mixins:["hashBinder","globalEvents","templated","configurable","statefull","gradable","toggleEnabled","shortcuts","transitionable"],events:{},defaultConfig:{elDragArea:".js-dragarea",elContainer:"body",nDraggerZ:600,aDraggerArgs:["sDragger[n]","sDragger[n]Text"],aBayArgs:["sBay[n]","sBay[n]Name","sBay[n]Draggers","sBay[n]Capacity"],bShuffleDraggers:!0,bShuffleBays:!0,bNormalizeWidth:!0,bNormalizeHeight:!1},templateId:"dragndrop",profileReady:function(){_.bindAll(this,"drop"),this.getDraggers(),this.getBays()},states:{ready:{enter:function(){}},active:{enter:function(){}},feedback:{enter:function(){}}},getDraggers:function(){this.draggers=this.model.groupForDisplay(this.config.aDraggerArgs,this.config.bShuffleDraggers,"dragger_","sDragger")},getBays:function(){this.bays=this.model.groupForDisplay(this.config.aBayArgs,this.config.bShuffleBays,"bays_","sBay")},normalizeWidth:function(){var a=_.max(_.map(this.$(".js-dragger"),function(a){return $(a).innerWidth()}));_.each(this.$(".js-bay, .js-dragger"),function(b){$(b).width(a)})},render:function(){var a=this.getTemplateData();this.template(this.getTemplateIdOr(),a),this.initDraggers(),this.initBays()},getTemplateData:function(){var a=this.model.toJSON();return a.draggers=this.draggers,a.bays=this.bays,a.config=this.config,a},initDraggers:function(){var a=this;this.$(".js-dragger").draggable({containment:this.config.elDragArea,appendTo:this.config.elContainer,zIndex:this.config.nDraggerZ,revert:function(){return a.valid($(this))},start:function(){a.start($(this))}})},initBays:function(){this.$(".js-bay").droppable({drop:this.drop})},getDraggerById:function(a){return _.findWhere(this.draggers,{id:a})},getBayById:function(a){return _.findWhere(this.bays,{id:a})},start:function(a){var b=this.getDraggerById(a.attr("id")),c=a.data("inBay");c&&(a.data("inBay",!1).removeClass("in-bay"),b.bay=null,b.inBay=!1)},drop:function(a,b){this.addDraggerToBay(b.draggable.attr("id"),$(a.target).attr("id"))},valid:function(a){var b=a.data("inBay");return b||this.resetDragger(a),!b},addDraggerToBay:function(a,b){var c=this.getDraggerById(a),d=this.getBayById(b),e=this.$("#"+c.id),f=this.$("#"+d.id);d.draggers?d.draggers.length>0:draggers=[],c.bay=d.sBay,c.inBay=!0,e.data("inBay",!0).addClass("in-bay"),this.alignToBay(e,f)},removeDraggerFromBay:function(a){{var b=this.getDraggerById(a);this.getBayById(elBay.attr("id"))}b.bay=null,b.inBay=!1,this.$("#"+b.id).data("inBay",!1).removeClass("in-bay")},resetDragger:function(a){a.data("uiDraggable").originalPosition={top:0,left:0}},isAllDropped:function(){return _.every(this.draggers,function(a){return a.inBay})},alignToBay:function(a,b){var c=b.offset(),d=a.offset(),e=c.left-d.left,f=c.top-d.top;this.config.nBayDockOffsetY&&(f+=this.config.nBayDockOffsetY),this.config.nBayDockOffsetX&&(e+=this.config.nBayDockOffsetX),a.animate({top:"+="+f,left:"+="+e})},beforeRemove:function(){$(".js-dragger").draggable("destroy"),$(".js-bay").droppable("destroy")}}),Blaze.dna.FillInBlanks=Blaze.View.extend({className:"activity-fill-in-blanks",mixins:["hashBinder","globalEvents","templated","configurable","statefull","activity","gradable","toggleEnabled","shortcuts","transitionable"],events:{"click .js-close":"close","click .js-next":"next","click .js-choice":"choose","click .js-submit":"submit","click .js-try":"tryAgian"},defaultConfig:{elDragArea:".js-dragarea",nDraggerZ:600,aDraggerArgs:["sDragger[n]","sDragger[n]Text"],aBayArgs:["sBay[n]","sBay[n]Text","sBay[n]Draggers"],bShuffleDraggers:!0,bShuffleBays:!0,bNormalizeWidth:!1,bNormalizeHeight:!1,sBayDelimiter:/_+/,bAutoSubmit:!0,bRetryTillCorrect:!0,bRetryOnlyIncorrect:!0},templateId:"dragndrop",profileReady:function(){_.bindAll(this,"drop"),this.getDraggers(),this.getBays()},states:{ready:{enter:function(){}},active:{enter:function(){}},feedback:{enter:function(){}}},getDraggers:function(){this.draggers=this.model.groupForDisplay(this.config.aDraggerArgs,this.config.bShuffleDraggers,"dragger_","sDragger"),console.log("DRAGGERS",this.draggers)},getBays:function(){var a=this.config.sBayDelimiter;this.bays=this.model.groupForDisplay(this.config.aBayArgs,this.config.bShuffleBays,"bays_","sBay"),_.each(this.bays,function(b){var c=b.sBayText.split(a);b.sText1=c[0],b.sText2=c[1],b.draggers=[]}),console.log("BAYS",this.bays)},normalizeWidth:function(){var a=_.max(_.map(this.$(".js-dragger"),function(a){return $(a).innerWidth()}));_.each(this.$(".js-bay, .js-dragger"),function(b){$(b).width(a)})},render:function(){var a=this.getTemplateData();this.template(this.getTemplateIdOr(),a),this.initDraggers(),this.initBays()},getTemplateData:function(){var a=this.model.toJSON();return a.draggers=this.draggers,a.bays=this.bays,a.config=this.config,a},initDraggers:function(){var a=this;this.$(".js-dragger").draggable({containment:this.config.elDragArea,appendTo:this.config.elContainer,zIndex:this.config.nDraggerZ,revert:function(){return a.valid($(this))},start:function(){a.start($(this))}})},initBays:function(){this.$(".js-bay").droppable({drop:this.drop})},getDraggerById:function(a){return _.findWhere(this.draggers,{id:a})},getBayById:function(a){return _.findWhere(this.bays,{id:a})},start:function(a){var b=this.getDraggerById(a.attr("id"));b&&b.inBay&&this.removeDraggerFromBay(b,b.bay)},drop:function(a,b){this.addDraggerToBay(b.draggable.attr("id"),$(a.target).attr("id"))},valid:function(a){var b=a.data("inBay");return b||this.resetDraggerEl(a),!b},addDraggerToBay:function(a,b){var c,d=this.getDraggerById(a),e=this.getBayById(b),f=this.$("#"+d.id),g=this.$("#"+e.id);e.draggers.length>0&&(c=e.draggers[0],this.removeDraggerFromBay(c,e),this.resetDraggerEl(this.$("#"+c.id))),d.bay=e,d.inBay=!0,e.draggers.push(d),console.log("DRAGGERS",e.draggers),f.data("inBay",!0).addClass("in-bay"),this.alignToBay(f,g),this.isAllDropped()&&(this.config.bAutoSubmit?this.submit():this.state("active"))},removeDraggerFromBay:function(a,b){a.bay=null,a.inBay=!1,b.draggers=[],this.$("#"+a.id).data("inBay",!1).removeClass("in-bay")},resetDraggerEl:function(a){a.data("uiDraggable").originalPosition={top:0,left:0},a.stop().animate({top:"0px",left:"0px"})},isAllDropped:function(){return _.every(this.draggers,function(a){return a.inBay})},alignToBay:function(a,b){var c=b.offset(),d=a.offset(),e=c.left-d.left,f=c.top-d.top;this.config.nBayDockOffsetY&&(f+=this.config.nBayDockOffsetY),this.config.nBayDockOffsetX&&(e+=this.config.nBayDockOffsetX),a.animate({top:"+="+f,left:"+="+e})},submit:function(){console.log("SUBMIT"),this.isAllCorrect()?(this.markAllComplete(),this.renderFeedback()):this.config.bRetryTillCorrect&&this.resetInncorretDraggers()},resetInncorretDraggers:function(){_.each(this.bays,function(a){var b=a.draggers[0],c=this.$("#"+b.id);return b?(c=this.$("#"+b.id),void(a.draggers[0].sDragger!=a.sBayDraggers?(this.removeDraggerFromBay(b,a),this.resetDraggerEl(c)):c.addClass("correct").draggable("disable"))):!1},this)},markAllComplete:function(){_.each(this.draggers,function(a){this.$("#"+a.id).addClass("correct")},this)},resetAllDraggers:function(){},isAllCorrect:function(){return _.every(this.bays,function(a){var b=a.draggers[0];return b?a.draggers[0].sDragger==a.sBayDraggers:!1})},beforeRemove:function(){$(".js-dragger").draggable("destroy"),$(".js-bay").droppable("destroy")}}),Blaze.dna.Hotspot=Blaze.View.extend({className:"activity-hotspot hotspot-selected-none",mixins:["hashBinder","globalEvents","templated","configurable","gradable","activity","toggleEnabled","shortcuts","transitionable"],events:{"click .js-hotspot":"select","click .js-hotspot-close":"closePopup"},transitions:{},args:{noneSelected:"sHotspotNoneText",noneSelectedHeader:"sHotspotNoneHeader"},defaultConfig:{bDeselctable:!0,bEnabled:!0,bShuffle:!1,sFollow:!1,sHotpotArgs:["sHotspot[n]","sHotspot[n]Label","sHotspot[n]Header","sHotspot[n]Text","sHotspot[n]Viewed"],sHotspotTemplate:null,sTemplate:null},render:function(){this.template(this.getTemplateIdOr(),this.getTemplateData()),this.mixinAfterRender()},profileReady:function(){this.hotspots=this.model.groupForDisplay(this.config.sHotpotArgs,this.config.bShuffle,"hs_","sHotspot"),this.$el.addClass("hospot-count-"+this.hotspots.length)},getTemplateData:function(){var a=this.model.toJSON();return a.hotspots=this.hotspots,a.config=this.config,a},select:function(a){var b=$(a.currentTarget);this.isEnabled()&&!b.hasClass(".hotspot-disabled")&&this.setSelected(b.attr("id"),b)},setSelected:function(a){var b=this,c=this.getHotspotById(a);return this.selected?this.selected&&this.selected.id==c.id?void(this.config.bDeselctable&&this.deselectHotspot(this.selected).then(function(){b.setDefaltText()})):(this.deselectHotspot(this.selected).then(function(){b.selectHotspot(c)}).fail(function(a){console.error(a,a.stack)}),void this.model.set("sHotspot"+c.i+"Viewed",!0)):void this.selectHotspot(c)},setDefaltText:function(){this.$(".js-hotspot-text").text(this.getArg("noneSelected")),this.$(".js-hotspot-header").text(this.getArg("noneSelectedHeader"))},deselectHotspot:function(a){var b=this,c=this._transitions["hotspotOut"+a.i]||this._transitions.hotspotOut,d=function(){b.onHotspotDeslected(a,a.i)};return c?this.transition(c,a.i).then(d):Q.fcall(d)},onHotspotDeslected:function(a){this.config.sHotspotTemplate?this.$(".js-hotspot-popup").empty():(this.$(".js-hotspot-label").html(""),this.$(".js-hotspot-text").text(""),this.$(".js-hotspot-header").text("")),this.$(".js-hotspot-popup").removeClass("hotspot-popup-"+a.i),this.$("#"+a.id).removeClass("hotspot-selected"),this.$el.removeClass("hotspot-selected-"+a.i).addClass("hotspot-selected-none"),this.selected=null},selectHotspot:function(a){var b=this._transitions["hotspotIn"+a.i]||this._transitions.hotspotIn;return this.onHotspotSelected(a),b?this.transition(b,a.i):void 0},onHotspotSelected:function(a){this.config.sHotspotTemplate?this.subTemplate(".js-hotspot-popup",this.config.sHotspotTemplate,a):(this.$(".js-hotspot-label").html(a.sHotspotLabel),this.$(".js-hotspot-text").html(a.sHotspotText),this.$(".js-hotspot-header").html(a.sHotspotHeader)),this.$(".js-hotspot-popup").addClass("hotspot-popup-"+a.i),this.$("#"+a.id).addClass("hotspot-selected hotspot-visited"),this.$el.removeClass("hotspot-selected-none").addClass("hotspot-selected-"+a.i),this.selected=a},getHotspotById:function(a){return _.findWhere(this.hotspots,{id:a})},setHotspotText:function(a){a.sHotspotText&&this.$(".js-hotspot-text").html(a.text.sHotspotText)},closePopup:function(){this.selected&&this.deselectHotspot(this.selected).then(function(){self.setDefaltText()})}}),Blaze.dna.MultChoice=Blaze.View.extend({className:"activity-mult-choice",mixins:["hashBinder","globalEvents","templated","configurable","commandable","statefull","activity","gradable","toggleEnabled","attempts","shortcuts","transitionable","timed"],args:{correct:"sCorrectChoice",feedbackAll:"sFeedbackAll",feedbackCorrect:"sCorrectFeedback",feedbackIncorrect:"sIncorrectFeedback",feedbackLast:"sLastFeedback"},events:{"click .js-close":"close","click .js-next":"next","click .js-choice":"choose","click .js-submit":"submit","click .js-try":"tryAgian"},templateId:"MultChoice",defaultConfig:{aChoiceArgs:["sChoice[n]","sChoice[n]Text"],bShuffle:!0,bAutoSubmit:!1,sTemplate:"MultChoice",bHideSubmit:!1,bShortcuts:!1,sShortcutType:"numeric",sFeedbackType:"general",sFeedbackTemplate:null,sAdaptor:"MultChoice",sFeedbackAdaptor:"MultChoiceFeedback",bModal:!1},profileReady:function(){_.bindAll(this,"resetChoices"),this.choices=this.model.groupForDisplay(this.config.aChoiceArgs,this.config.bShuffle,"choice_","sChoice")},states:{ready:{enter:function(){this.$(".js-choice").addClass("unselected"),this.enable(),this.startCountdown()}},active:{enter:function(){this.enable()}},pause:{enter:function(){this.disable(),this.renderFeedback(),this.config.bModal||this.resetChoices()}},feedback:{enter:function(){this.disable(),this.markChoices(),this.renderFeedback(),this.markCompleted()}},review:{enter:function(){this.disable(),this.setChoice(this.getAnswered()),this.markChoices()}}},render:function(){this.template(this.getTemplateIdOr(),this.getTemplateData(this.config.sAdaptor)),this.isCompleted()&&!this.config.bRepeatable?this.state("review"):(this.markStarted(),this.state("ready")),this.mixinAfterRender()},submit:function(){if("branching"!=this.config.sFeedbackType){{this.grade()}return this.setAttempted(this.getAnswered()),"none"==this.config.sFeedbackType?void this.next():void this.state(this.isCorrect()||!this.canAttempt()?"feedback":"pause")}},evaluator:function(){var a=this.getAnswered(),b=this.getArg("correct");return!_.isUndefined(a)&&_.isEqual(a,b)},choose:function(a){this.setChoice($(a.currentTarget).attr("id")),a.preventDefault()},setChoice:function(a){if(this.isEnabled()){var b=this.getChoiceByElementId(a);b&&(this.clearSelected(),this.setSelected(b.id),this.setAnswered(b.sChoice),this.state("active"),this.config.bAutoSubmit&&this.submit())}},clearSelected:function(){this.$(".selected").removeClass("selected").addClass("unselected")},setSelected:function(a){this.$("#"+a).addClass("selected").removeClass("unselected")},getChoice:function(a){return _.findWhere(this.choices,{sChoice:a})},getChoiceByElementId:function(a){return _.findWhere(this.choices,{id:a})},getChoiceNum:function(){var a=_.findWhere(this.choices,{sChoice:this.getAnswered()});return a?a.i:void 0},onDisabled:function(){this.removeShortcuts()},onEnabled:function(){this.canShortcut&&this.addShortcuts()},canShortcut:function(){return this.config.bShortcuts&&this.choices&&!this.hasShortcuts()},addShortcuts:function(){var a=this,b="alpha"==this.config.sShortcutType?"letter":"num";_.each(this.choices,function(c){a.addShortcut(c[b].toString(),function(){a.setChoice(c.sChoice)})}),this.addShortcut("enter",function(){var b=$($("*:focus")[0]);(!b.hasClass("js-choice")||b.hasClass("selected"))&&a.submit()})},markChoices:function(){var a=this.getArg("correct");_.each(this.choices,function(b){this.$("#"+b.id).addClass(a==b.sChoice?"correct":"incorrect")},this)},resetChoices:function(){this.$(".js-choice").removeClass("selected").addClass("unselected"),this.model.set("answered",null),this.resetCountdown(),this.state("ready")},tryAgian:function(){this.transitionOr("feedbackOut",function(){this.$(".js-feedback").hide()}).then(this.resetChoices)}}),Blaze.Adaptors.add("MultChoice",function(){var a=this.model.toJSON();return a.choices=this.choices,a}),Blaze.Adaptors.add("MultChoiceFeedback",function(){var a=this.isCorrect(),b=this.canAttempt(),c=this.getChoiceNum(),d={isCorrect:a,nChoosen:c,canAttempt:b&&!a};switch(this.config.sFeedbackType){case"general":d.feedback=this.getArg("feedback"+(a?"Correct":"Incorrect"));break;case"specific":d.feedback=this.model.get("sChoice"+c+"Feedback")}return a||b||!this.getArg("feedbackLast")||(d.feedback=this.getArg("feedbackLast")),d}),Blaze.dna.MultSelect=Blaze.View.extend({className:"activity-mult-select",mixins:["hashBinder","globalEvents","templated","configurable","statefull","gradable","activity","toggleEnabled","attempts","shortcuts","transitionable"],events:{"click .js-close":"close","click .js-next":"next","click .js-choice":"choose","click .js-submit":"submit","click .js-try":"tryAgian"},args:{correct:"sCorrectChoices",feedbackAll:"sFeedbackAll",feedbackCorrect:"sCorrectFeedback",feedbackIncorrect:"sIncorrectFeedback",feedbackLast:"sLastFeedback",maxSelected:"nMaxSelected"},defaultConfig:{bShuffle:!0,aChoiceArgs:["sChoice[n]","sChoice[n]Text"],sTemplate:"MultSelect",sAlert:null,bRevealAnswers:!0,bSubmitNone:!1,sFeedbackType:"general",sFeedbackTemplate:null,sAdaptor:"MultSelect",sFeedbackAdaptor:"MultSelectFeedback",bModal:!1},profileReady:function(){_.bindAll(this,"resetChoices"),this.choices=this.model.groupForDisplay(this.config.aChoiceArgs,this.config.bShuffle,"choice_","sChoice")},states:{ready:{enter:function(a){"active"!=a&&this.$(".js-choice").addClass("unselected"),this.enable()}},active:{enter:function(){this.enable()}},feedback:{enter:function(){this.disable(),this.markChoices(),this.renderFeedback(),this.markCompleted()}},review:{enter:function(){}},pause:{enter:function(){this.disable(),this.renderFeedback(),console.log("this.config.bModal",this.config.bModal),this.config.bModal||this.resetChoices()}}},render:function(){this.model.set("answered",null),this.template(this.getTemplateIdOr(),this.getTemplateData(this.config.sAdaptor)),this.state("ready"),this.mixinAfterRender()},choose:function(a){this.toggleChoice($(a.currentTarget).attr("id")),a.preventDefault()},toggleChoice:function(a){if(this.isEnabled()){var b=this.getChoiceByElementId(a),c=this.$("#"+b.id),d=c.hasClass("selected"),e=parseInt(this.getArg("maxSelected"));!d&&_.isNumber(e)&&this.getSelectedCount()>=e||(this.toggleAnswered(b.sChoice),c.toggleClass("selected",!d).toggleClass("unselected",d),this.state(this.canSubmit()?"active":"ready"))}},getSelectedCount:function(){var a=this.model.get("answered");return a?a.length:0},toggleAnswered:function(a){var b=this.model.get("answered")||[];_.contains(b,a)?b=_.without(b,a):b.push(a),this.model.set("answered",b)},getChoice:function(a){return _.findWhere(this.choices,{sChoice:a})},getChoiceByElementId:function(a){return _.findWhere(this.choices,{id:a})},onDisabled:function(){this.removeShortcuts()},onEnabled:function(){this.canShortcut},canSubmit:function(){return this.config.bSubmitNone||this.$(".js-choice.selected").length>0},submit:function(){return this.canSubmit()?(this.grade(),this.setAttempted(),"none"==this.config.sFeedbackType?void this.next():void this.state(this.isCorrect()||!this.canAttempt()?"feedback":"pause")):void 0},evaluator:function(){var a=this.model.get("answered")||[],b=this.getArg("correct")||"";return _.isEqual(a.sort(),b.split(Blaze.regx.splitCommaTrim).sort())},markChoices:function(){var a=this.getArg("correct");a=a&&""!==a?a.split(Blaze.regx.splitCommaTrim):[],_.each(this.choices,function(b){this.$("#"+b.id).addClass(_.contains(a,b.sChoice)?"correct":"incorrect")},this)},clearSelected:function(){this.$(".selected").removeClass("selected").addClass("unselected")},canShortcut:function(){return this.config.bShortcuts&&this.choices&&!this.hasShortcuts()},resetChoices:function(){this.$(".js-choice").removeClass("selected").addClass("unselected"),this.model.set("answered",null),this.state("ready"),console.log("should be ready!",this.state())},next:function(){this.triggerGlobal("command:run","next")},tryAgian:function(){this.transitionOr("feedbackOut",function(){console.log("HIDE Feedback"),this.$(".js-feedback").hide()}).then(this.resetChoices)}}),Blaze.Adaptors.add("MultSelect",function(a){var b=a.toJSON();return b.choices=this.choices,b}),Blaze.Adaptors.add("MultSelectFeedback",function(){var a=this.isCorrect(),b=this.canAttempt();switch(fb={isCorrect:a,canAttempt:b&&!a},this.config.sFeedbackType){case"general":fb.feedback=this.getArg("feedback"+(a?"Correct":"Incorrect"));break;case"specific":}return!fb.feedback&&this.getArg("feedbackLast")&&(fb.feedback=this.getArg("feedbackLast")),console.log("fb",fb),fb}),Blaze.dna.OptionGroup=Blaze.View.extend({className:"activity-option-group",mixins:["hashBinder","globalEvents","templated","configurable","statefull","gradable","activity","toggleEnabled","attempts","shortcuts","transitionable"],events:{"click .js-close":"close","click .js-next":"next","click .js-choice":"choose","click .js-submit":"submit","click .js-try":"tryAgian"},args:{correct:"sCorrectChoices",feedbackAll:"sFeedbackAll",feedbackCorrect:"sCorrectFeedback",feedbackIncorrect:"sIncorrectFeedback",feedbackLast:"sLastFeedback"},defaultConfig:{bShuffle:!0,aGroupArgs:["sGroup[n]"],aChoiceArgs:["sChoice[n]","sChoice[n]Text"],sTemplate:"OptionGroup",sAlert:null,bRevealAnswers:!0,bSubmitNone:!1,sFeedbackType:"general",sFeedbackTemplate:null,sAdaptor:"OptionGroup",sFeedbackAdaptor:"OptionGroupFeedback",bModal:!1},profileReady:function(){_.bindAll(this,"resetChoices"),this.choices=this.model.groupForDisplay(this.config.aChoiceArgs,this.config.bShuffle,"choice_","sChoice"),this.groups=this.model.collapseArgs(this.config.aGroupArgs),_.each(this.choices,function(a){a.groupID=this.getGroup(a.sChoice).i},this),this.answered=[]},states:{ready:{enter:function(a){"active"!=a&&this.$(".js-choice").addClass("unselected"),this.enable()}},active:{enter:function(){this.enable()}},feedback:{enter:function(){this.disable(),this.markChoices(),this.renderFeedback(),this.markCompleted()}},review:{enter:function(){}},pause:{enter:function(){this.disable(),this.renderFeedback(),console.log("this.config.bModal",this.config.bModal),this.config.bModal||this.resetChoices()}}},render:function(){this.answered=[],this.template(this.getTemplateIdOr(),this.getTemplateData(this.config.sAdaptor)),this.state("ready"),this.mixinAfterRender()},getGroupChoices:function(a){var b=this.getGroup(a),c=b.sGroup.split(",");return c},choose:function(a){this.setChoice($(a.currentTarget).attr("id")),a.preventDefault()},setChoice:function(a){var b=this.getChoiceByElementId(a),c=this.$("#"+b.id),d=(c.hasClass("selected"),this),e=this.getGroupChoices(b.sChoice);$(".group-"+b.groupID).removeClass("selected").addClass("unselected"),_.each(e,function(a){d.removeAnswered(a)}),this.setAnswered(b.sChoice),c.removeClass("unselected").addClass("selected"),this.state(this.canSubmit()?"active":"ready")},setAnswered:function(a){_.contains(this.answered,a)||this.answered.push(a)},removeAnswered:function(a){_.contains(this.answered,a)&&(this.answered=_.without(this.answered,a))},getChoice:function(a){return _.findWhere(this.choices,{sChoice:a})},getGroup:function(a){return _.find(this.groups,function(b){return b.sGroup.indexOf(a)>=0})},getChoiceByElementId:function(a){return _.findWhere(this.choices,{id:a})},onDisabled:function(){this.removeShortcuts()},onEnabled:function(){this.canShortcut},canSubmit:function(){return console.log("answers: "+this.answered),this.config.bSubmitNone||this.$(".js-choice.selected").length===this.groups.length},submit:function(){return this.canSubmit()?(this.grade(),this.setAttempted(),"none"==this.config.sFeedbackType?void this.next():void this.state(this.isCorrect()||!this.canAttempt()?"feedback":"pause")):void 0},evaluator:function(){var a=this.answered,b=this.getArg("correct")||"";return console.log("answered:",a.sort()),console.log("correct:",b.split(Blaze.regx.splitCommaTrim).sort()),_.isEqual(a.sort(),b.split(Blaze.regx.splitCommaTrim).sort())},markChoices:function(){var a=this.getArg("correct");a=a&&""!==a?a.split(Blaze.regx.splitCommaTrim):[],_.each(this.choices,function(b){this.$("#"+b.id).addClass(_.contains(a,b.sChoice)?"correct":"incorrect")},this)},clearSelected:function(){this.$(".selected").removeClass("selected").addClass("unselected")},canShortcut:function(){return this.config.bShortcuts&&this.choices&&!this.hasShortcuts()},resetChoices:function(){this.$(".js-choice").removeClass("selected").addClass("unselected"),this.answered=[],this.state("ready"),console.log("should be ready!",this.state())},next:function(){this.triggerGlobal("command:run","next")},tryAgian:function(){this.transitionOr("feedbackOut",function(){this.$(".js-feedback").hide()}).then(this.resetChoices)}}),Blaze.Adaptors.add("OptionGroup",function(a){var b=a.toJSON();return b.choices=this.choices,b}),Blaze.Adaptors.add("OptionGroupFeedback",function(){var a=this.isCorrect(),b=this.canAttempt();switch(fb={isCorrect:a,canAttempt:b&&!a},log("OPTION GROUP FEEDBACK "+this.isCorrect()),this.config.sFeedbackType){case"general":fb.feedback=this.getArg("feedback"+(a?"Correct":"Incorrect"));break;case"specific":}return!fb.feedback&&this.getArg("feedbackLast")&&(fb.feedback=this.getArg("feedbackLast")),console.log("fb",fb),fb}),Blaze.dna.PieSlider=Blaze.View.extend({className:"activity-pie-slider",mixins:["hashBinder","globalEvents","statefull","templated","configurable","toggleEnabled","activity","gradable","attempts","transitionable","timed"],args:{percent:"nPercent",correct:"nCorrect"},events:{"mousedown .js-thumb":"startDrag","touchstart .js-thumb":"startDrag","click .js-close":"close","click .js-next":"next","click .js-submit":"submit","click .js-try":"tryAgian"},defaultConfig:{sTemplate:"PieSlider",cBgColor:"#333333",bBackgroundCircle:!1,cSliceColor:"#c66901",cInnerColor:"#000000",nDiameter:252,bInnerCircle:!1,nInnerDiameter:140,nThumbDiameter:195,nCanvasWidth:252,nCanvasHeight:252,nTolerance:10,nDegreeOffset:270,sCanvasId:".js-chart",sPercentLabelId:".js-percent",sThumbId:".js-thumb",sTipId:".js- tip",bModal:!1},initialize:function(){_.bindAll(this,"drag","release")},render:function(){this.template(this.getTemplateIdOr(),this.getTemplateData(this.config.sAdaptor)),this.state("active"),this.mixinAfterRender();var a=this;window.setPer=function(b){a.model.set("nPercent",b),a.update()},window.setOffset=function(b){a.config.nDegreeOffset=b}},states:{active:{enter:function(){this.reset(),this.enable(),this.update()}},pause:{enter:function(){this.disable(),this.renderFeedback(),!this.config.bModal}},feedback:{enter:function(){this.disable(),this.renderFeedback(),this.drawResult(),this.markCompleted()}},review:{enter:function(){this.disable(),this.update(),this.renderFeedback(),this.drawResult()}}},evaluator:function(){var a=this.getArg("percent"),b=this.getArg("correct");return!_.isUndefined(a)&&_.isEqual(a,b)},submit:function(){if(this.isState("active")){{this.grade()}return this.setAttempted(this.getArg("percent")),"none"==this.config.sFeedbackType?void this.next():void this.state(this.isCorrect()||!this.canAttempt()?"feedback":"pause")}},startDrag:function(a){this.isState("active")&&(a.preventDefault(),this.setPointer(),this.getThumb().addClass("pressed"),this.bindWindow())},drag:function(a){a.preventDefault();var b=this.getMousePosition(a),c=this.getCanvasCenter(),d=Math.atan2(b.y-c.y,b.x-c.x);ang=Math.round(this.radiansToDegrees(d)),ang<0&&(ang+=360),ang-=360,ang=Math.abs(ang),this.setPercent(this.calcPercentFromAngle(ang)),this.update()},release:function(){this.removePointer(),this.releaseWindow(),this.getThumb().removeClass("pressed")},update:function(){var a=this.getArg("percent"),b=this.getArc(a);this.drawChart(this.getContext(this.config.sCanvasId),b),this.setThumbPosition(b),this.updateLabel(this.config.sPercentLabelId,a)},setThumbPosition:function(a){var b=this.config.nThumbDiameter/2,c=b*Math.cos(a.end)+this.config.nCanvasWidth/2,d=b*Math.sin(a.end)+this.config.nCanvasHeight/2;this.getThumb().css({top:d+"px",left:c+"px"})},drawChart:function(a,b){var c=this.config.nCanvasHeight/2,d=this.config.nCanvasWidth/2;this.clearChart(a),this.config.bBackgroundCircle===!0&&this.drawCircle(a,this.config.nDiameter/2,d,c,this.config.cBgColor),this.drawArc(a,this.config.nDiameter/2,d,c,b.start,b.end),this.config.bInnerCircle===!0&&this.drawCircle(a,this.config.nInnerDiameter/2,d,c,this.config.cInnerColor)},drawResult:function(){var a=this.getArg("correct");this.drawChart(this.getContext(".js-result"),this.getArc(a)),this.updateLabel(".js-percent-actual",a)},clearChart:function(a){a.clearRect(0,0,this.config.nDiameter,this.config.nDiameter)},setPercent:function(a){this.model.set(this.args.percent,a)},calcPercentFromAngle:function(a){var b=a-this.config.nDegreeOffset;return 0>b&&(b+=360),100-Math.floor(100*b/360)},getThumb:function(){return this.$el.find(this.config.sThumbId)},hideThumb:function(){this.getThumb().hide()},showThumb:function(){this.getThumb().show()},radiansToDegrees:function(a){return a*(180/Math.PI)},degreesToRadians:function(a){return a*(Math.PI/180)},percentToAngle:function(a){return Math.round(3.6*a)},angleToPercent:function(){},updateLabel:function(a,b){this.$el.find(a).text(b+"%")},hideTooltip:function(){this.$el.find(this.config.sTipId).fadeOut(200)},beforeRemove:function(){this.removePointer(),this.releaseWindow()},setPointer:function(){$("body").css("cursor","pointer")},removePointer:function(){$("body").css("cursor","default")},bindWindow:function(){$(window).on("mousemove touchmove",this.drag),$(window).on("mouseup touchend",this.release)},releaseWindow:function(){$(window).off("mousemove touchmove",this.drag),$(window).off("mouseup touchend",this.release)},getCanvasCenter:function(){var a=this.$(this.config.sCanvasId).offset();return{y:a.top+this.config.nCanvasHeight/2,x:a.left+this.config.nCanvasWidth/2}},getMousePosition:function(a){var b="touchmove"===a.type?a.originalEvent.changedTouches[0]:a;return{
y:b.clientY,x:b.clientX}},reset:function(){this.model.set(this.args.percent,0)},getContext:function(a){return this.$el.find(a)[0].getContext("2d")},getArc:function(a){var b=this.config.nDegreeOffset%360,c=(b-Math.round(3.6*a))%360;return b-=360,b=Math.abs(b),c-=360,c=Math.abs(c),{start:this.degreesToRadians(b),end:this.degreesToRadians(c)}},drawArc:function(a,b,c,d,e,f){a.fillStyle=this.config.cSliceColor,a.beginPath(),a.arc(c,d,b,e,f,!1),a.arc(c,d,this.config.nInnerDiameter/2,f,e,!0),a.fill()},drawCircle:function(a,b,c,d,e){a.fillStyle=e,a.beginPath(),a.arc(c,d,b,0,2*Math.PI,!1),a.fill()}}),Blaze.dna.Slider=Blaze.View.extend({className:"activity-slider",mixins:["hashBinder","globalEvents","templated","configurable","commandable","statefull","gradable","toggleEnabled","attempts","transitionable"],events:{"slidechange .js-slider":"slideChange","click .js-submit":"submit"},args:{max:"nMax",min:"nMin",correct:"sCorrect",start:"nStart",step:"nStep"},defaultConfig:{sTemplate:"Slider",sAdaptor:"Slider",bMulti:!1,bRepeatable:!0,bAutoSubmit:!1,sOrientation:"horizontal",bRange:!1,nStep:1,nLabelStep:1},states:{active:{enter:function(){}},pause:{enter:function(){}},feedback:{enter:function(){}},review:{enter:function(){}}},render:function(){this.template(this.getTemplateIdOr(),this.getTemplateData(this.config.sAdaptor)),this.state("ready"),this.mixinAfterRender(),this.initSlider()},initSlider:function(){this.slider=$(".js-slider").slider({min:this.getArg("min"),max:this.getArg("max"),orientation:this.config.sOrientation,range:this.config.bRange,step:this.getArg("step")||this.config.nStep,start:this.getArg("start")})},slideChange:function(a,b){console.log("slider change",a,b),this.config.bAutoSubmit&&this.submit(),this.setAnswered($(".js-slider").slider("value"))},evaluator:function(){var a,b=this.getArg(this.args.correct),c=this.getAnswered();return b||c?_.isNumber(b)?_.isEqual(c,b):_.isString(b)?(a=b.split(Blaze.regx.splitCommaTrim),c>=parseInt(a[0])&&c<=parseInt(a[1])):void 0:!1},submit:function(){this.grade(),this.setAttempted(this.getAnswered()),console.log("EVAL",this.evaluator())}}),Blaze.dna.Sorting=Blaze.View.extend({className:"activity-sorting",mixins:["hashBinder","globalEvents","templated","configurable","statefull","activity","gradable","toggleEnabled","shortcuts","transitionable"],events:{"click .js-close":"close","click .js-next":"next","click .js-choice":"choose","click .js-submit":"submit","click .js-try":"tryAgian"},defaultConfig:{elDragArea:".js-dragarea",elContainer:"body",nDraggerZ:600,aDraggerArgs:["sDragger[n]","sDragger[n]Name"],aBayArgs:["sBay[n]","sBay[n]Text","sBay[n]Draggers","sBay[n]Capacity"],bShuffleDraggers:!0,bShuffleBays:!0,bNormalizeWidth:!1,bNormalizeHeight:!1,bAutoSubmit:!0,bRetryTillCorrect:!0,bRetryOnlyIncorrect:!0},templateId:"dragndrop",profileReady:function(){_.bindAll(this,"drop"),this.getDraggers(),this.getBays()},states:{ready:{enter:function(){}},active:{enter:function(){}},feedback:{enter:function(){}}},getDraggers:function(){this.draggers=this.model.groupForDisplay(this.config.aDraggerArgs,this.config.bShuffleDraggers,"dragger_","sDragger")},getBays:function(){this.bays=this.model.groupForDisplay(this.config.aBayArgs,this.config.bShuffleBays,"bays_","sBay"),_.each(this.bays,function(a){a.draggers=[],a.correct=a.sBayDraggers.split(Blaze.regx.splitCommaTrim)})},normalizeWidth:function(){var a=_.max(_.map(this.$(".js-dragger"),function(a){return $(a).innerWidth()}));_.each(this.$(".js-bay, .js-dragger"),function(b){$(b).width(a)})},render:function(){this.template(this.getTemplateIdOr(),this.getTemplateData()),this.initDraggers(),this.initBays()},getTemplateData:function(){var a=this.model.toJSON();return a.draggers=this.draggers,a.bays=this.bays,a.config=this.config,a},initDraggers:function(){_.each(this.draggers,this.initDragger,this)},initDragger:function(a){var b=this,c=this.$("#"+a.id);a.$el=c,c.draggable({containment:this.config.elDragArea,appendTo:this.config.elContainer,zIndex:this.config.nDraggerZ,revert:function(){return b.valid($(this))},start:function(){b.start($(this))}})},initBays:function(){_.each(this.bays,this.initBay,this)},initBay:function(a){var b=this.$("#"+a.id);a.$el=b,b.droppable({drop:this.drop})},getDraggerById:function(a){return _.findWhere(this.draggers,{id:a})},getBayById:function(a){return _.findWhere(this.bays,{id:a})},start:function(a){var b,c=this.getDraggerById(a.attr("id"));c&&c.inBay&&(b=c.bay,this.removeDraggerFromBay(c,b),this.realignDraggers(b))},drop:function(a,b){this.addDraggerToBay(b.draggable.attr("id"),$(a.target).attr("id"))},valid:function(a){var b=a.data("inBay");return b||this.resetDraggerEl(a),!b},addDraggerToBay:function(a,b){var c,d=this.getDraggerById(a),e=this.getBayById(b),f=this.$("#"+d.id),g=this.$("#"+e.id);if((!e.sBayCapacity||1==e.sBayCapacity)&&e.draggers.length>=1){if(currentDragger=e.draggers[0],this.isDraggerDisable(currentDragger.id))return void this.resetDraggerEl(this.$("#"+d.id));this.removeDraggerFromBay(currentDragger,e),this.resetDraggerEl(this.$("#"+currentDragger.id))}else if(e.draggers.length>=e.sBayCapacity)return;c=g.find(".js-align-"+e.draggers.length),e.draggers.push(d),d.bay=e,d.inBay=!0,f.data("inBay",!0).addClass("in-bay"),this.alignToBay(f,c.length?c:g),this.isAllDropped()&&this.config.bAutoSubmit&&this.submit()},isDraggerDisable:function(a){return $("#"+a).draggable("option","disabled")},realignDraggers:function(a){_.each(a.draggers,function(b,c){this.alignToBay(b.$el,a.$el.find(".js-align-"+c))},this)},removeDraggerFromBay:function(a,b){a.bay=null,a.inBay=!1,b.draggers=_.without(b.draggers,a),this.$("#"+a.id).data("inBay",!1).removeClass("in-bay")},resetDraggerEl:function(a){a.data("uiDraggable").originalPosition={top:0,left:0},a.stop().animate({top:"0px",left:"0px"})},isAllDropped:function(){return _.every(this.draggers,function(a){return a.inBay})},submit:function(){this.isAllCorrect()?(this.markAllComplete(),this.renderFeedback(),this.markCompleted()):this.config.bRetryTillCorrect&&this.resetInncorretDraggers()},isAllCorrect:function(){return _.every(this.bays,this.isBayCorrect,this)},isBayCorrect:function(a){var b=_.map(a.draggers,function(a){return a.sDragger});return!_.difference(a.correct,b).length},alignToBay:function(a,b){var c=b.offset(),d=a.offset(),e=c.left-d.left,f=c.top-d.top;this.config.nBayDockOffsetY&&(f+=this.config.nBayDockOffsetY),this.config.nBayDockOffsetX&&(e+=this.config.nBayDockOffsetX),a.animate({top:"+="+f,left:"+="+e})},resetInncorretDraggers:function(){_.each(this.bays,function(a){_.each(a.draggers,function(b){var c=this.$("#"+b.id);c.finish(),_.contains(a.correct,b.sDragger)?c.addClass("correct").draggable("disable"):(this.removeDraggerFromBay(b,a),this.resetDraggerEl(c))},this),this.realignDraggers(a)},this)},markAllComplete:function(){_.each(this.draggers,function(a){this.$("#"+a.id).addClass("correct")},this)},beforeRemove:function(){_.each(this.draggers,function(a){a.$el=null}),_.each(this.bays,function(a){a.$el=null}),$(".js-dragger").draggable("destroy"),$(".js-bay").droppable("destroy")}}),Blaze.dna.SortList=Blaze.View.extend({className:"sort-list",templateId:"SortList",mixins:["hashBinder","globalEvents","templated","configurable","commandable","statefull","gradable","toggleEnabled","attempts","transitionable"],defaultConfig:{sDraggerArgs:["sDragger[n]","sDragger[n]Text"],sAdaptor:"ListSort",bShuffle:!0,sFeedbackType:"general",sFeedbackTemplate:null},args:{order:"sDraggerOrder",feedbackCorrect:"sCorrectFeedback",feedbackIncorrect:"sIncorrectFeedback",feedbackLast:"sLastFeedback"},events:{"click .js-submit":"submit"},states:{active:{enter:function(){this.$(".js-list").sortable({containment:this.$(".js-dragarea"),revert:!0}).disableSelection(),this.enable()}},feedback:{enter:function(){this.disable();var a=this.getFeedback();this.config.sFeedbackTemplate?this.subTemplate(".js-feedback",this.config.sFeedbackTemplate,{isCorrect:this.isCorrect(),feedback:a,order:this.getCurrentOrder().join()}):this.$(".js-feedback").html(a)}}},profileReady:function(){this.draggers=this.model.groupForDisplay(this.config.sDraggerArgs,this.config.bShuffle,"item_","sItem")},render:function(){this.template(this.getTemplateIdOr(),this.getTemplateData(this.config.sAdaptor)),this.state("active"),this.mixinAfterRender()},evaluator:function(){return _.isEqual(this.getCurrentOrder(),this.getArg("order").split(Blaze.regx.splitCommaTrim))},getCurrentOrder:function(){return _.map(this.$(".js-list").children(),function(a){var b=this.getItemByElementId($(a).attr("id"));return b?b.sItem:null},this)},getItemByElementId:function(a){return _.findWhere(this.draggers,{id:a})},submit:function(){return this.grade(),this.setAttempted(),"none"==this.config.sFeedbackType?void this.next():(this.state("feedback"),void(!this.isCorrect()&&this.canAttempt()&&this.state("active")))},getFeedback:function(){var a,b=this.isCorrect();switch(this.config.sFeedbackType){case"general":a=this.getArg("feedback"+(b?"Correct":"Incorrect"));break;case"specific":a=this.model.get("sOrder"+this.getCurrentOrder().join()+"Feedback")}return b||this.canAttempt()||!this.getArg("feedbackLast")||(a=this.getArg("feedbackLast")),a},next:function(){this.triggerGlobal("command:run","next")},onDisabled:function(){this.$(".js-list").sortable("disable")},onEnabled:function(){this.$(".js-list").sortable("enable")}}),Blaze.Adaptors.add("ListSort",function(){var a=this.model.toJSON();return a.draggers=this.draggers,a})}();