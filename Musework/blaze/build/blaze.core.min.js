!function(){var a={dispatcher:_.clone(Backbone.Events),loadAsset:function(b,c,d){var e=Q.defer();return $.ajax({url:b,dataType:c,success:function(c){_.isFunction(d)&&d(c),a.dispatcher.trigger("asset:loaded",c,b),e.resolve(c)},error:function(b,c,d){console.log(b,c,d),a.dispatcher.trigger("load:error","url",d),e.reject(new Error(d))}}),e.promise},regx:{stripNonNumeric:/^[0-9]+$/,count_:/[^_]/g,splitCommaTrim:/\s*,\s*/},dna:{}};window.Blaze=a,a._extend=function(b,c){this==a&&console.error("you cannot extend Blaze in this way");var d=Backbone.Model.extend.call(this,b,c),e=d.prototype.mixins;return d.prototype.isMixed||a.Mixer.makeMixable(d),e&&d.prototype.hasOwnProperty("mixins")&&a.Mixer.mix(d,e),d},a.Mixer={_mixins:{},add:function(a,b){var c;if(a&&_.isString(a)&&_.isObject(b)||(c="Mixer.add requires a id and a object definition"),this.has(a)&&(c="Mixer.add duplicate mixin "+a+" will not be added"),c)throw c;this._mixins[a]=b},has:function(a){return _.has(this._mixins,a)},get:function(a){return this._mixins[a]},mix:function(a,b){_.isString(b)&&this._applyMixin(a,b),_.isArray(b)&&_.each(b,function(b){this._applyMixin(a,b)},this)},_applyMixin:function(a,b){if(!this.has(b))throw"cannot mixin "+b+" not found";var c=this.get(b);_.isFunction(a)?Cocktail.mixin(a,c):_.extend(a,c)},makeMixable:function(b){var c=_.isFunction(b)?b.prototype:b;return _.extend(c,a.Mixer.Mixable)}},a.Mixer.Mixable={isMixed:!0,hasMixin:function(a){return this.mixins&&_.isArray(this.mixins)?_.isString(a)?_.contains(this.mixins,a):_.isArray(a)?_.intersection(this.mixins,a).length==a.length:!1:!1}};var b={silent:!0},c=function(a,b){return a.replace("[n]",b)},d=function(a){return function(b,d){return b[c(d,"")]=a.get([c(d,b.i)]),b}};a.Model=Backbone.Model.extend({constructor:function(a){this.mixinBeforeInitialize(),this.serializer=a&&_.isArray(a.serializer)?a.serializer:[],Backbone.Model.apply(this,arguments),this.mixinAfterInitialize()},mixinBeforeInitialize:function(){},mixinAfterInitialize:function(){},collapseArgs:function(a,b){_.isArray(a)||(a=[a]);for(var e=_.isNumber(b)?b:0,f=[],g=(this.attributes,!1),h=a[0],i=d(this);!g;)this.get(c(h,e))?(f.push(_.reduce(a,i,{i:e})),e++):g=!0;return f},groupForDisplay:function(b,c,d,e){var f=this.collapseArgs(b);return c&&(f=_.shuffle(f)),a.utils.addUniqueIds(f,d),a.utils.addNumbering(f),e&&_.each(f,function(a){this.set(e+a.i+"Id",a.id)},this),f},getOr:function(a,b){return this.has(a)?this.get(a):b},incCounter:function(a,b){var c=this.get(a);return c||(c=0),c+=b||1,this.set(a,c),c},decCounter:function(a,b){var c=this.get(a);return c||(c=0),c-=b||1,this.set(a,c),c},setPush:function(a,b,c){var d=this.get(a);if(d){if(c===!0&&_.contains(d,b))return;d.push(c)}else d=[b];this.set(a,d)},setShift:function(){},setSerializer:function(a){this.serializer=a},serialize:function(){return _.map(this.serializer,function(a){return this.get(a)},this)},deserialize:function(a){this.serializer&&_.isArray(a)&&_.each(this.serializer,function(b,c){this.set(b,a[c],{silent:!0})},this)},toString:function(){return"(model) "+(this.id||this.cid)}}),a.Model.extend=a._extend,a.Collection=Backbone.Collection.extend({model:a.Model}),a.Collection.extend=a._extend;var e={},f=function(a){return _.isFunction(a.toJSON)?a.toJSON():a};a.Adaptors={add:function(a,b){e[a]=b},convert:function(a,b,c){return this.get(a).call(c,b)},get:function(a){return a?e[a]||f:f}},a.View=Backbone.View.extend({mixinBeforeInitialize:function(){},mixinAfterInitialize:function(){},mixinBeforeRemove:function(){},mixinBeforeRender:function(){},mixinAfterRender:function(a){return a},constructor:function(a){this.mixinBeforeInitialize(a),Backbone.View.apply(this,arguments),this.mixinAfterInitialize(a)},beforeRemove:function(){},remove:function(){var a=this,b=[];return this.beforeRemove(b),this.mixinBeforeRemove(b),Q.all(b).then(function(){Backbone.View.prototype.remove.apply(a,arguments)})},getTemplateData:function(b){var c={};return this.model&&(c=a.Adaptors.convert(b,this.model,this)),this.config&&(c.config=this.config),c},getTarget:function(a){return $(a.currentTarget)},getTargetData:function(a,b){return this.getTarget(a).data(b)},getTargetId:function(a){return this.getTarget(a).attr("id")},args:{},getArg:function(a){return this.model.get(this.args[a]||a)}}),a.Mixer.makeMixable(a.View),a.View.extend=a._extend;a.Alerts={_alerts:{},_queue:[],_default:null,register:function(a,b,c,d){this._alerts[a]={id:a,que:c===!0,func:b},(d||!this._default)&&this.setDefault(a)},spawn:function(b,c,d){var e,f=this.get(b);return f&&_.isFunction(f.func)?void(f.que?(e=_.toArray(arguments),e[0]=f,this._queue.push(e),1==this._queue.length&&this._next()):this._process(b,c,d)):void a.dispatcher.trigger("alert:error",b+" alert does not exist")},_process:function(b,c,d){var e;return e=Q.defer(),b.func(e,c),e.promise.then(function(c){_.isFunction(d)&&d(c),a.dispatcher.trigger("alert:complete",b.id,c)}).fail(function(a){console.error(a,a.stack)}),e.promise},_next:function(){this._queue.length<1?a.dispatcher.trigger("alert:empty"):this._process.apply(this,this._queue[0]).then(function(){a.Alerts._queue.shift(),a.Alerts._next()})},get:function(a){return this._alerts[a]||this._alerts[this._default]},has:function(a){return _.contains(_.keys(this._alerts),a)},setDefault:function(a){this._default=a}},a.dispatcher.on("alert:spawn",a.Alerts.spawn,a.Alerts),a.Application=Backbone.Router.extend({constructor:function(b){b||(b={}),a[b.appName||"app"]=this,this.mixinBeforeInitialize(b),Backbone.Router.apply(this,arguments),this.mixinAfterInitialize(b)},mixinBeforeInitialize:function(){},mixinAfterInitialize:function(){},setDocumentTitle:function(a){document.title=a}}),a.Application.extend=a._extend,a.Command=function(b,c,d,e){if(!_.isFunction(c))throw new Error("Blaze.Command requires a command function");this.id=b,this.scope=e||a.app,this.cmd=c,this.once=!1,this.shortcut=d,d&&a.utils.keybind("cmd_"+b,d,function(){a.Commands.run(b)})},_.extend(a.Command.prototype,{run:function(){a.dispatcher.trigger("command:before",this.id),this.cmd.apply(this.scope,arguments),a.dispatcher.trigger("command:after",this.id)},release:function(){a.utils.keyunbind("cmd_"+this.id),this.scope=null},lock:function(){this._locked=!0},unlock:function(){this._locked=!1},isLocked:function(){return this._locked}}),a.Commands={_commands:{},_overrides:{},add:function(a,b,c,d){return this.has(a)?void console.warn("command cannot be added, try removing the current command "+a+" first."):(this._commands[a]=this.create(a,b,c,d),this)},addOnce:function(b,c,d,e){var f=function(){c.apply(this,arguments),a.Commands.remove(b)};return this.add(b,f,d,e),this},create:function(b,c,d,e){return new a.Command(b,c,d,e)},has:function(a){return _.has(this._commands,a)},get:function(a){return this._commands[a]},run:function(a){var b=this.hasOverride(a)?this.getOverride(a):this.get(a);return b&&_.isFunction(b.run)&&!b.isLocked()&&b.run.apply(b,_.toArray(arguments).slice(1)),this},remove:function(a){return this.has(a)?(this._commands[a].release(),delete this._commands[a],this):void 0},clear:function(){return _.invoke(this._commands,"release"),this._commands={},this},override:function(a,b,c){return this._overrides[a]=this.create(a,b,c),this},overrideOnce:function(b,c,d){var e=function(){c.apply(this,arguments),a.Commands.removeOverride(b)};return this._commands[b]=this.override(b,e,d),this},removeOveride:function(a){return this.hasOverride(a)?(this._overrides[a].release(),delete this._overrides[a],this):void 0},hasOverride:function(a){return _.has(this._overrides,a)},getOverride:function(a){return this._overrides[a]},clearOverrides:function(){return _.invoke(this._overrides,"release"),this._overrides={},this},getCommandList:function(){return{commands:this.getCommandData(this._commands),overrides:this.getCommandData(this._overrides)}},getCommandData:function(a){return _.map(a,function(a){return{id:a.id,shortcut:a.shortcut||""}})},lock:function(a){this.has(a)&&this.get(a).lock(),this.hasOverride(a)&&this.getOverride(a).lock()},unlock:function(a){this.has(a)&&this.get(a).unlock(),this.hasOverride(a)&&this.getOverride(a).unlock()}},a.dispatcher.on("command:run",function(b){a.Commands.run(b,_.toArray(arguments).slice(1))}),a.dispatcher.on("command:lock",function(b){a.Commands.lock(b)}),a.dispatcher.on("command:unlock",function(b){a.Commands.unlock(b)}),a.Configs=function(){var b=new Backbone.Collection,c=function(c){_.each($(c).find("profile"),function(a){var c=$(a),d=_.reduce(c.find("config"),function(a,b){var c=$(b);return a[c.attr("name")]=_.processAttr(c.attr("value")),a},{id:c.attr("name")});b.add(d)}),a.dispatcher.trigger("configs:loaded")};return{load:function(b){return a.loadAsset(b+".xml","xml",c)},add:function(a,c,d){var e=b.get(a);c.id=a,e?d===!0&&(e.clear({silent:!0}),e.set(c)):b.add(new Backbone.Model(c))},get:function(a,c){var d=b.get(a);return d?c?d.get(c):d.toJSON():c?null:{}},is:function(a,b,c){return this.get(a,b)==c},has:function(){return this.get(profile)},getAll:function(){return b.toJSON()}}}(),a.dna.LabelCollection=Backbone.Model.extend({notifyMissing:!0,load:function(b){return a.loadAsset(b+".xml","xml",_.bind(this._parse,this))},_parse:function(c){this.set(_.reduce(_.getXmlNodes(_.getXmlNodes(c,"labels"),"label"),function(a,b){var c=$(b);return a[c.attr("id")]=c.text(),a},{}),b),a.dispatcher.trigger("labels:loaded",this)},add:function(a,c){var d={};d[a]=c,this.set(d,b)},get:function(a){var b=Backbone.Model.prototype.get.call(this,a);return b?b:this.notifyMissing?"Missing Label "+a:""}}),a.Labels=new a.dna.LabelCollection;var g=function(){return!0};a.Parser=function(a,b){_.isFunction(b)||(console.warn("parser initialized without parser function, a pass through function will be applied"),b=function(){return _.toArray(arguments)}),this.match=_.isString(a)?""===a?g:function(b){return b==a}:_.isRegExp(a)?function(b){return a.test(b)}:_.isFunction(a)?a:_.isObject(a)?function(b){return _.isArray(b)?_.findWhere(b,a):_.isObject(b)?_.findWhere([b],a):!1}:g,this.parse=b};var h={};a.Parsers={add:function(b,c,d){h[b]=new a.Parser(c,d)},parse:function(a,b){var c;if(_.isArray(a))a=_.find(a,function(a){var c=h[a];return c?c.match(b):!1}),c=h[a];else if(c=h[a],c&&!c.match(b))return void console.error("failed parsing ",a);return c?c.parse.apply(this,_.toArray(arguments).slice(2)):void console.error("could not find parser "+a)}},a.QueryObject=function(a,b){this.model=a,this.scope=b},_.extend(a.QueryObject.prototype,{run:function(){return this.deferred=Q.defer(),this.deferred},result:function(a,b){a?this.deferred.reject(a):this.deferred.resolve(b)}}),a.Resource=a.Model.extend({}),a.ResourcesCollection=Backbone.Collection.extend({model:a.Resource,load:function(b){return a.loadAsset(b+".xml","xml",_.bind(this._parse,this))},_parse:function(a){console.log("Loaded reources",a);var b=[];_.each($(a).find("resource"),function(a){var c=_.getXmlAttrs(a);(!c.id||slang.isBlank(c.id))&&(c.id=_.uniqueId("resources_")),b.push(c)}),this.add(b)}}),a.Resources=new a.ResourcesCollection,a.Templates={notifyMissing:!0,_templates:{},_partials:{},_helpers:{},selectors:{template:"script[type*=mustache]",partial:"script[type*=partial]"},load:function(b,c,d){return a.loadAsset(b+".html","html",function(b){a.Templates._parseHTML($("<div>"+b+"</div>"),c,d)})},loadSingleTemplate:function(b,c){return a.loadAsset(c+".html","html",function(c){a.Templates.addTemplate(b,c)})},getFromDom:function(a,b){this._parseHTML($("body"),a,b)},addTemplate:function(a,b){this._templates[a]=b},addPartial:function(a,b){this._partials[a]=b},addHelper:function(a,b){_.isFunction(b)&&(this._helpers[a]=function(){return b})},getPartial:function(a){return this._partials[a]},getTemplate:function(a){return this._templates[a]},getHelper:function(a){return this._helpers[a]},hasPartial:function(a){return _.has(this._partials,a)},hasTemplate:function(a){return _.has(this._templates,a)},hasMatch:function(b){var c=a.Templates._templates;return _.find(b,function(a){return _.isString(a)?!_.isUndefined(c[a]):!1})},hasHelper:function(a){return _.has(this._helpers,a)},render:function(a,b,c){return this.hasTemplate(a)?this.renderRaw(this.getTemplate(a),b,c):this.notifyMissing?"Missing Template "+a:""},renderRaw:function(a,b,c){return Mustache.render(a,this._addHelpers(b),this._addPartials(c))},_parseHTML:function(a,b,c){var d=b||this.selectors.template,e=c||this.selectors.partial;_.extend(this._templates,this._extractor(a,d)),_.extend(this._partials,this._extractor(a,e))},_extractor:function(a,b){return _.reduce($(b,a),function(a,b){return b=$(b),a[b.attr("id")]=b.html(),a},{})},_addHelpers:function(a){return a?_.extend({},this._helpers,a):this._helpers},_addPartials:function(a){return a?_.extend({},this._partials,a):this._partials},getAvailable:function(){return{templates:_.keys(this._templates),partials:_.keys(this._partials),helpers:_.keys(this._helpers)}}},a.Templates.addHelper("partial",function(a,b){return b("{{>"+slang.trim(b(a))+"}}")}),a.Templates.addHelper("template",function(b,c){return c(a.getTemplate(c(slang.trim(b))))}),a.Templates.addHelper("label",function(b,c){return a.Labels.get(c(slang.trim(b)))}),a.Transitions={_trans:{},add:function(a,b){return this._trans[a]=b,this},run:function(a,b,c){var d=c||this,e=_.isFunction(a)?a:this._trans[a],f=_.toArray(arguments).slice(1);return _.isFunction(e)||(e=function(){}),Q.fcall(function(){return e.apply(d,f)}).fail(function(a){console.error("transition failed",a,a.stack)})},has:function(a){return a?this._trans[a]:!1}},a.Tree=function(a){this.nodes=[],this.node_indexes={},this._config(a),this.initialize()},_.extend(a.Tree.prototype,{_config:function(){},initialize:function(){},onAdded:function(){},add:function(a,b){var c,d=0;return a?(b?(d=b.get("depth")+1,b.addNode(a)):this.root||(a.setIndex(0),this.root=a),a.setDepth(d),c=a.get("nodeid"),c||(c=_.uniqueId("node_"),a.set({nodeid:c},{silent:!0})),this.node_indexes[c]?void console.error("Duplicate node id: "+c+"node not added."):(a.tree=this,this.node_indexes[c]=this.nodes.push(a)-1,void this.onAdded(a))):void console.error("tried to add null node.")},get:function(a){return this.nodes[this.node_indexes[a]]},toString:function(){return"tree ("+this.nodes+")"}});var i=["forEach","each","map","collect","reduce","reduceRight","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","toArray","size","first","initial","rest","last","without","indexOf","lastIndexOf","sample"];_.each(i,function(b){a.Tree.prototype[b]=function(){var a=_.toArray(arguments);return a.unshift(this.nodes),_[b].apply(_,a)}}),a.Tree.extend=a._extend,a.regx.forwardSlashes=/\//g,a.TreeNode=a.Model.extend({defaults:{nodeType:"node"},initialize:function(){this.nodes=new Backbone.Collection,this.get("nodeid")||this.set("nodeid",_.uniqueId("node"))},is:function(a){var b=this.get("nodeType");return _.isArray(a)?_.contains(a,b):b==a},count:function(a){return _.isFunction(a)?this.nodes.filter(a).length:this.nodes.length},setParent:function(a){this.parent=a},addNode:function(a){a.setParent(this),a.setIndex(this.count()),this.nodes.add(a),this.onAdded(a)},onAdded:function(){},getFormatedNodeId:function(b){return this.get("nodeid").replace(a.regx.forwardSlashes,b||"-")},setIndex:function(a){this.set({index:a},b)},setDepth:function(a){this.set({depth:a},b)},at:function(a){return this.nodes.at(a)},nextSibling:function(){return this.parent.at(this.get("index")+1)},prevSibling:function(){return this.parent.at(this.get("index")-1)},firstChild:function(){return this.nodes.at(0)},lastChild:function(){return this.nodes.at(this.nodes.length-1)},hasChildren:function(){return this.nodes.length>0},getChild:function(a){return this.nodes.get(a)},findChild:function(a,b){if(b&&a(this))return this;for(var c,d=this.nodes.models,e=d.length,f=0;e>f;f++)if(c=d[f].findChild(a,!0))return c},findChildren:function(a,b){return b?a(this)&&b.push(this):b=[],this.nodes.length&&this.nodes.each(function(c){c.findChildren(a,b)}),b},findParent:function(a){return a(this)?this:this.parent?this.parent.findParent(a):null},each:function(a){a(this),this.nodes.each(function(b){b.each(a)})},getChildrenNodeIds:function(){return this.nodes.map(function(a){return a.get("nodeid")})},getParents:function(){for(var a=[],b=this.parent;b;)a.push(b),b=b.parent;return a},reduceUp:function(a,b,c){var d=this.getParents();return c&&d.unshift(this),_.reduce(d,a,b)},mapUp:function(a,b){var c=this.getParents();return b&&c.unshift(this),_.map(c,a)},reduceDown:function(){},toString:function(){return this.get("nodeType")+":"+this.get("nodeid")}}),a.TreeNode.extend=a._extend,a.utils={addNumbering:function(a){if(!_.isArray(a))return a;var b="abcdefghijklmnopqrstuvwxyz";return _.each(a,function(a,c){a.letter=b.charAt(c),a.num=c+1,a.human=slang.humanize(a.num)}),a},addUniqueIds:function(a,b,c){return _.isArray(a)?(b||(b="blaze_"),c||(c="id"),_.each(a,function(a){a[c]=_.uniqueId(b)}),a):a},keybind:function(a,b,c){var d=$("html"),e=!window.jwerty||d.hasClass("ie7")||d.hasClass("ie8")?function(){console.log("keybinding without jwery not implemented for old IE yet")}:window.jwerty.event(b,c);$(document.body).bind("keydown."+a,e)},keyunbind:function(a){$(document.body).unbind("."+a)},addEvents:function(a){_.extend(a.prototype,Backbone.Events)},getModelAttrs:function(a){return a?a.attributes||a:{}},replaceSlashes:function(b,c){return b.replace(a.regx.forwardSlashes,c||"-")},wrapPromise:function(a){var b=Q.defer();return a(function(){b.resolve()}),b.promise}}}();